/*!
 *   File: integrations/instacart.js
 *   Release: v20250826.1
 *   Commit: 19868d5f634ad426e79981f5489f578224361999
 *   Stage: production
 *   Date: 2025-08-28T17:57:04.496Z
 *
 */!function(){"use strict";let t="",e="",i="";const o=new Map;function n(t){return window._fwn.shopping.productFactory((e=>{const{pricing:i,details:o,size:n}=t.shop_level_attributes,{unit_price:r,estimated_each_price:a}=i.final_price,s=a??r,c=e.description(o.details_description).extId(String(t.id)).name(t.name).currency(s.currency);return c.image((e=>e.extId(t.id).position(0).url(t.image_url).imageId(t.id).unitIds([]).unitExtIds([]))),c.variant((e=>{const i=e.extId(String(t.id)).name(n??"Default Title").price(s.amount_cents/100).url(t.permalink_url);return t.image_url&&i.image((e=>e.extId(t.id).position(0).url(t.image_url).imageId(t.id).unitIds([]).unitExtIds([]))),i})),c}))}async function r(){const e=await fetch(`${t}/idp/v1/users/self/location`,{method:"GET",credentials:"include"});if(!e.ok)return console.error("Failed to get user location for Instacart"),"";const i=await e.json(),{postal_code:o}=i,n=await fetch(`${t}/idp/v1/shops?postal_code=${o}`,{method:"GET",credentials:"include"});if(!n.ok)return console.error("Failed to get nearby shops for Instacart"),"";const{shops:r}=await n.json();return r[0].id}async function a(e){const i=await r();if(!i)return console.error("Failed to get shop ID for Instacart"),[];const o=await fetch(`${t}/idp/v1/products?shop_id=${i}&product_ids[]=${e.join("&product_ids[]=")}&expands[]=details&expands[]=price`,{method:"GET",credentials:"include"});if(!o.ok)return console.error("Failed to get products from Instacart"),[];const{products:n}=await o.json();return n}async function s(){!function(){const i=document.querySelector("script[data-storefront][data-checkout-path]");t=i?.getAttribute("data-storefront")||"",e=i?.getAttribute("data-checkout-path")||""}();try{if(!(await fetch(`${t}/idp/v1/init`,{method:"POST",credentials:"include",headers:{"Access-Control-Allow-Credentials":"true","Access-Control-Allow-Origin":t}})).ok)return void console.error("Failed to initialize Instacart session");const i=await r();if(!i)return void console.error("Failed to get shop ID for Instacart");window._fwn.shopping.configureCart({url:`${t}${e}?sid=${i}`,currency:"USD"})}catch(t){console.error(t)}}function c(){s(),window._fwn.shopping.onProductsLoaded((async t=>{const e=t.products.map((t=>Number(t.product_ext_id))).filter((t=>!Number.isNaN(t))),i=await a(e);return i.map((t=>o.set(t.id,t))),i.map((t=>n(t)))})),window._fwn.shopping.onCartDisplayed((async()=>{const e=await fetch(`${t}/idp/v1/carts/personal`,{method:"GET",credentials:"include"});if(!e.ok)return console.error("Failed to get carts"),[];const{carts:r}=await e.json();i=r[0].id;const s=await fetch(`${t}/idp/v1/carts/${i}/items`,{method:"GET",credentials:"include"});if(!s.ok)return console.error("Failed to get cart items"),[];const{items:c}=await s.json();if(c.length>0){const t=c.map((t=>t.product_id));return(await a(t)).map((t=>o.set(t.id,t))),c.map((t=>({product:n(o.get(t.product_id)||{id:t.product_id,name:"Unknown",permalink_url:"",image_url:""}),unitId:t.product_id,quantity:t.quantity})))}return[]})),window._fwn.shopping.onCartUpdated((async({productUnit:e,quantity:n})=>{const a=await r();if(!a)return console.error("Failed to get shop ID for Instacart"),0;const s=o.get(e.product_ext_id);return(await fetch(`${t}/idp/v1/carts/${i}/items`,{method:"PUT",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({cart_items:[{product_id:e.product_ext_id,quantity:n,quantity_type:s?.shop_level_attributes?.quantity_attributes.quantity_type.toLowerCase()??"each"}],shop_id:a,affiliate_id:4203})})).ok?n:(console.error("Failed to update cart"),0)}))}window._fwn?.shopping?c():document.addEventListener("fw:shopping:ready",(()=>{c()}))}();